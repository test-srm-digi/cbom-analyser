# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Unified CI/CD Pipeline â€” Build, Scan, xBOM, Docker, Release
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Combines CI, xBOM generation, and Release into a single workflow.
#
#   â€¢ push / PR to main        â†’ build + test + CBOM self-scan + Docker + xBOM
#   â€¢ release created          â†’ all of the above + attach artifacts to release
#   â€¢ workflow_dispatch        â†’ manual trigger with configurable inputs
#
# Artifacts produced:
#   - backend-dist / frontend-dist   â€” build outputs
#   - cbom-report                    â€” CBOM Analyser output (cryptographic assets)
#   - sbom-report                    â€” Trivy SBOM (software components + CVEs)
#   - xbom-report                    â€” Unified xBOM (SBOM + CBOM + cross-refs)

name: Pipeline

on:
  push:
    branches: [main, X-bom]
  pull_request:
    branches: [main, master]
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      scan-path:
        description: 'Path within the repository to scan'
        required: false
        default: '.'
      fail-on-vulnerable:
        description: 'Fail if non-quantum-safe crypto is found'
        required: false
        default: 'false'
      trivy-severity:
        description: 'Trivy severity filter (e.g. CRITICAL,HIGH)'
        required: false
        default: ''
      exclude-patterns:
        description: 'Comma-separated glob patterns to exclude from CBOM scan'
        required: false
        default: 'default'

permissions:
  contents: read
  security-events: write
  actions: read

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Jobs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  1. Build â€” Backend & Frontend                          â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci
        env:
          GH_NPM_TOKEN: ${{ secrets.GH_NPM_TOKEN }}
          FONTAWESOME_TOKEN: ${{ secrets.FONTAWESOME_TOKEN }}

      - name: Build backend
        run: npm run build
        working-directory: backend

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: backend/dist

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci
        env:
          GH_NPM_TOKEN: ${{ secrets.GH_NPM_TOKEN }}
          FONTAWESOME_TOKEN: ${{ secrets.FONTAWESOME_TOKEN }}

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  2. CBOM Self-Scan  (needs backend build)               â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  cbom-scan:
    name: CBOM Self-Scan
    runs-on: ubuntu-latest
    needs: [build-backend]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: backend/dist

      - name: Install dependencies
        run: npm ci

      - name: Start backend & run self-scan
        run: |
          cd backend
          node dist/index.js &
          sleep 5
          curl -s -X POST http://localhost:3001/api/scan-code \
            -H "Content-Type: application/json" \
            -d '{"repoPath": "${{ github.workspace }}", "repoUrl": "${{ github.server_url }}/${{ github.repository }}", "branch": "${{ github.ref_name }}"}' > scan-result.json

          python3 -c "
          import json
          with open('scan-result.json') as f:
            data = json.load(f)
          with open('${{ github.workspace }}/cbom-report.json', 'w') as f:
            json.dump(data.get('cbom', {}), f, indent=2)
          print(f'ðŸŽ¯ Quantum Readiness: {data.get(\"readinessScore\",{}).get(\"score\")}%')
          print(f'ðŸ“¦ Total Assets: {len(data.get(\"cbom\",{}).get(\"cryptoAssets\",[]))}')
          repo = data.get('cbom',{}).get('metadata',{}).get('repository',{})
          if repo.get('url'):
            print(f'ðŸ”— Repository: {repo[\"url\"]}')
          if repo.get('branch'):
            print(f'ðŸŒ¿ Branch: {repo[\"branch\"]}')
          "

      - name: Upload CBOM Report
        uses: actions/upload-artifact@v4
        with:
          name: cbom-report
          path: cbom-report.json
          retention-days: 90

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  3. SBOM â€” Trivy software scan                          â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  sbom-scan:
    name: SBOM Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install & Run Trivy (SBOM + Vulnerabilities)
        run: |
          sudo apt-get update -qq && sudo apt-get install -yqq wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -qq && sudo apt-get install -yqq trivy
          trivy version
          trivy fs \
            --format cyclonedx \
            --output sbom.json \
            --severity "${{ github.event.inputs.trivy-severity || 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL' }}" \
            --scanners vuln,license \
            "${{ github.event.inputs.scan-path || '.' }}"

      - name: Upload SBOM Report
        uses: actions/upload-artifact@v4
        with:
          name: sbom-report
          path: sbom.json
          retention-days: 90

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  4. xBOM â€” Merge SBOM + CBOM into unified BOM           â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  xbom-merge:
    name: Generate xBOM
    runs-on: ubuntu-latest
    needs: [cbom-scan, sbom-scan]
    steps:
      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: sbom-report

      - name: Download CBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: cbom-report

      - name: Merge SBOM + CBOM â†’ xBOM
        uses: actions/github-script@v7
        id: merge
        with:
          script: |
            const fs = require('fs');

            // Read both BOMs
            const sbom = JSON.parse(fs.readFileSync('sbom.json', 'utf-8'));
            const cbomRaw = JSON.parse(fs.readFileSync('cbom-report.json', 'utf-8'));
            const cbom = cbomRaw.cbom || cbomRaw;

            // â”€â”€ Merge logic â”€â”€
            const crypto = require('crypto');
            const serialNumber = `urn:uuid:${crypto.randomUUID()}`;

            // Build tools list
            const tools = [];
            if (sbom.metadata?.tools) {
              const sbomTools = Array.isArray(sbom.metadata.tools)
                ? sbom.metadata.tools
                : (sbom.metadata.tools.components || []);
              tools.push(...sbomTools.map(t => ({
                vendor: t.vendor || 'Aqua Security',
                name: t.name,
                version: t.version || 'unknown'
              })));
            }
            if (cbom.metadata?.tools) {
              const cbomTools = Array.isArray(cbom.metadata.tools)
                ? cbom.metadata.tools
                : (cbom.metadata.tools.services || []).map(s => ({
                    vendor: s.provider?.name || 'Unknown',
                    name: s.name,
                    version: s.version || 'unknown'
                  }));
              tools.push(...cbomTools);
            }
            tools.push({ vendor: 'QuantumGuard', name: 'xBOM Merge', version: '1.0.0' });

            // Software components from SBOM
            const components = sbom.components || [];

            // Crypto assets from CBOM
            const cryptoAssets = cbom.cryptoAssets || [];

            // CBOM crypto-typed components
            const cbomComponents = (cbom.components || []).filter(
              c => c.type === 'cryptographic-asset'
            );

            // Merge dependencies
            const dependencies = [
              ...(sbom.dependencies || []),
              ...(cbom.dependencies || [])
            ];

            // Vulnerabilities from Trivy
            const vulnerabilities = sbom.vulnerabilities || [];

            // Build cross-references
            const crossReferences = [];
            const thirdPartyLibs = cbom.thirdPartyLibraries || [];

            for (const lib of thirdPartyLibs) {
              const match = components.find(c => {
                if (!c.purl) return false;
                if (lib.groupId && lib.artifactId) {
                  return c.purl.includes(`${lib.groupId}/${lib.artifactId}`) ||
                         c.purl.includes(`${lib.groupId}%2F${lib.artifactId}`);
                }
                return c.name === lib.name;
              });

              if (match?.['bom-ref']) {
                const cryptoRefs = cryptoAssets
                  .filter(a => lib.cryptoAlgorithms.some(alg =>
                    a.name.toLowerCase().includes(alg.toLowerCase())
                  ))
                  .map(a => a.id);

                if (cryptoRefs.length > 0) {
                  crossReferences.push({
                    softwareRef: match['bom-ref'],
                    cryptoRefs,
                    linkMethod: 'dependency-manifest'
                  });
                }
              }
            }

            // Assemble xBOM
            const xbom = {
              bomFormat: 'CycloneDX',
              specVersion: '1.6',
              serialNumber,
              version: 1,
              metadata: {
                timestamp: new Date().toISOString(),
                tools,
                component: sbom.metadata?.component || cbom.metadata?.component,
                repository: {
                  url: `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}`,
                  branch: process.env.GITHUB_REF_NAME
                }
              },
              components: [...components, ...cbomComponents],
              cryptoAssets,
              dependencies,
              vulnerabilities,
              crossReferences,
              thirdPartyLibraries: thirdPartyLibs.length > 0 ? thirdPartyLibs : undefined
            };

            fs.writeFileSync('xbom.json', JSON.stringify(xbom, null, 2));

            // â”€â”€ Compute analytics â”€â”€
            const totalComponents = components.length;
            const totalCrypto = cryptoAssets.length;
            const qSafe = cryptoAssets.filter(a => a.quantumSafety === 'quantum-safe').length;
            const notSafe = cryptoAssets.filter(a =>
              a.quantumSafety === 'not-quantum-safe' || a.quantumSafety === 'unknown'
            ).length;
            const conditional = cryptoAssets.filter(a => a.quantumSafety === 'conditional').length;
            const readinessScore = totalCrypto > 0 ? Math.round((qSafe / totalCrypto) * 100) : 100;

            const vulnCritical = vulnerabilities.filter(v => v.ratings?.some(r => r.severity === 'critical')).length;
            const vulnHigh = vulnerabilities.filter(v =>
              v.ratings?.some(r => r.severity === 'high') && !v.ratings?.some(r => r.severity === 'critical')
            ).length;
            const vulnMedium = vulnerabilities.filter(v => v.ratings?.some(r => r.severity === 'medium')).length;

            // Set outputs
            core.setOutput('total-components', totalComponents);
            core.setOutput('total-crypto-assets', totalCrypto);
            core.setOutput('total-vulnerabilities', vulnerabilities.length);
            core.setOutput('total-cross-references', crossReferences.length);
            core.setOutput('readiness-score', readinessScore);
            core.setOutput('quantum-safe', qSafe);
            core.setOutput('not-quantum-safe', notSafe);
            core.setOutput('vuln-critical', vulnCritical);
            core.setOutput('vuln-high', vulnHigh);

            core.exportVariable('XBOM_COMPONENTS', totalComponents);
            core.exportVariable('XBOM_CRYPTO', totalCrypto);
            core.exportVariable('XBOM_VULNS', vulnerabilities.length);
            core.exportVariable('XBOM_XREFS', crossReferences.length);
            core.exportVariable('XBOM_SCORE', readinessScore);
            core.exportVariable('XBOM_SAFE', qSafe);
            core.exportVariable('XBOM_NOT_SAFE', notSafe);
            core.exportVariable('XBOM_CONDITIONAL', conditional);
            core.exportVariable('XBOM_VULN_CRITICAL', vulnCritical);
            core.exportVariable('XBOM_VULN_HIGH', vulnHigh);
            core.exportVariable('XBOM_VULN_MEDIUM', vulnMedium);

            console.log(`âœ… xBOM generated: ${totalComponents} software, ${totalCrypto} crypto, ${vulnerabilities.length} CVEs, ${crossReferences.length} cross-refs`);

      - name: Generate xBOM Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ” xBOM Report â€” Unified SBOM + CBOM

          ### Overview

          | Metric | Value |
          |--------|-------|
          | ðŸ“¦ Software Components | **${{ env.XBOM_COMPONENTS }}** |
          | ðŸ”‘ Cryptographic Assets | **${{ env.XBOM_CRYPTO }}** |
          | ðŸ›¡ï¸ Vulnerabilities (CVEs) | **${{ env.XBOM_VULNS }}** |
          | ðŸ”— Cross-References | **${{ env.XBOM_XREFS }}** |

          ### Quantum Readiness

          | Metric | Value |
          |--------|-------|
          | ðŸŽ¯ Readiness Score | **${{ env.XBOM_SCORE }}%** |
          | âœ… Quantum-Safe | ${{ env.XBOM_SAFE }} |
          | âš ï¸ Not Quantum-Safe | ${{ env.XBOM_NOT_SAFE }} |
          | ðŸ”„ Conditional | ${{ env.XBOM_CONDITIONAL }} |

          ### Vulnerability Breakdown

          | Severity | Count |
          |----------|-------|
          | ðŸ”´ Critical | ${{ env.XBOM_VULN_CRITICAL }} |
          | ðŸŸ  High | ${{ env.XBOM_VULN_HIGH }} |
          | ðŸŸ¡ Medium | ${{ env.XBOM_VULN_MEDIUM }} |

          ---
          *Generated by [QuantumGuard Pipeline](https://github.com/${{ github.repository }})*
          EOF

      - name: Upload xBOM Report
        uses: actions/upload-artifact@v4
        with:
          name: xbom-report
          path: xbom.json
          retention-days: 90

      - name: Check thresholds
        if: github.event.inputs.fail-on-vulnerable == 'true'
        run: |
          NOT_SAFE=${{ env.XBOM_NOT_SAFE }}
          if [ "$NOT_SAFE" -gt 0 ]; then
            echo "âŒ $NOT_SAFE non-quantum-safe cryptographic assets detected"
            exit 1
          fi
          echo "âœ… All cryptographic assets are quantum-safe"

    outputs:
      total-components: ${{ steps.merge.outputs.total-components }}
      total-crypto-assets: ${{ steps.merge.outputs.total-crypto-assets }}
      total-vulnerabilities: ${{ steps.merge.outputs.total-vulnerabilities }}
      total-cross-references: ${{ steps.merge.outputs.total-cross-references }}
      readiness-score: ${{ steps.merge.outputs.readiness-score }}
      quantum-safe: ${{ steps.merge.outputs.quantum-safe }}
      not-quantum-safe: ${{ steps.merge.outputs.not-quantum-safe }}
      vuln-critical: ${{ steps.merge.outputs.vuln-critical }}
      vuln-high: ${{ steps.merge.outputs.vuln-high }}

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  5. Docker â€” Build all images                            â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Backend Docker Image
        run: docker build -t cbom-analyser-backend:${{ github.sha }} ./backend

      - name: Build Frontend Docker Image
        run: |
          docker build \
            --build-arg FONTAWESOME_TOKEN=${{ secrets.FONTAWESOME_TOKEN }} \
            --build-arg GH_NPM_TOKEN=${{ secrets.GH_NPM_TOKEN }} \
            -t cbom-analyser-frontend:${{ github.sha }} ./frontend

      - name: Build Action Docker Image
        run: docker build -t cbom-analyser-action:${{ github.sha }} -f Dockerfile.action .

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  6. Release â€” only when a release is created              â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  release:
    name: Attach Artifacts to Release
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [build-backend, build-frontend, cbom-scan, xbom-merge]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Attach artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            cbom-report/cbom-report.json
            sbom-report/sbom.json
            xbom-report/xbom.json
