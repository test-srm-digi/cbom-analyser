/**
 * VulnerabilityPanel — Shared vulnerability table with severity filters
 * Used in both CbomDetailPage and XBOMPage
 */
import { useState, useMemo } from 'react';
import { Bug } from 'lucide-react';
import type { SBOMVulnerability } from '../../types';
import VulnSummaryGrid from './VulnSummaryGrid';
import Pagination from '../Pagination';

interface Props {
  vulns: SBOMVulnerability[];
  /** Optional pre-computed summary (from XBOMAnalytics). If omitted, computed from vulns. */
  summary?: { total: number; critical: number; high: number; medium: number; low: number; info: number };
}

export default function VulnerabilityPanel({ vulns, summary }: Props) {
  const [sevFilter, setSevFilter] = useState<string>('all');
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(25);

  const computedSummary = useMemo(() => {
    if (summary) return summary;
    const m: Record<string, number> = { critical: 0, high: 0, medium: 0, low: 0, info: 0 };
    for (const v of vulns) {
      const sev = (v.ratings?.[0]?.severity ?? 'unknown').toLowerCase();
      if (sev in m) m[sev]++;
    }
    return { total: vulns.length, ...m } as { total: number; critical: number; high: number; medium: number; low: number; info: number };
  }, [vulns, summary]);

  const filtered = useMemo(() => {
    if (sevFilter === 'all') return vulns;
    return vulns.filter(v => {
      const sev = (v.ratings?.[0]?.severity ?? 'unknown').toLowerCase();
      return sev === sevFilter;
    });
  }, [vulns, sevFilter]);

  // Reset page when filter changes
  const filteredLen = filtered.length;
  const [prevFilteredLen, setPrevFilteredLen] = useState(filteredLen);
  if (filteredLen !== prevFilteredLen) { setPrevFilteredLen(filteredLen); setPage(1); }

  const paged = useMemo(() => {
    const start = (page - 1) * pageSize;
    return filtered.slice(start, start + pageSize);
  }, [filtered, page, pageSize]);

  if (vulns.length === 0) {
    return <div style={{ padding: 32, textAlign: 'center', color: 'var(--dc1-text-muted)' }}>No vulnerabilities detected. ✓</div>;
  }

  const sevColor = (sev: string) => {
    switch (sev) {
      case 'critical': return { bg: '#fee2e2', text: '#dc2626' };
      case 'high': return { bg: '#ffedd5', text: '#ea580c' };
      case 'medium': return { bg: '#fef3c7', text: '#d97706' };
      case 'low': return { bg: '#dbeafe', text: '#2563eb' };
      default: return { bg: '#f1f5f9', text: '#64748b' };
    }
  };

  return (
    <>
      {/* Summary grid */}
      <VulnSummaryGrid vuln={computedSummary} activeSev={sevFilter} onToggle={(sev: string) => setSevFilter(sevFilter === sev ? 'all' : sev)} />

      {/* Table */}
      <div className="dc1-card" style={{ marginBottom: 0 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
          <h3 style={{ margin: 0, fontSize: 14, fontWeight: 600 }}>
            <Bug size={15} style={{ marginRight: 6, verticalAlign: -2 }} />
            Vulnerabilities ({filtered.length})
          </h3>
          {sevFilter !== 'all' && (
            <button onClick={() => setSevFilter('all')} style={{ fontSize: 11, background: 'none', border: '1px solid var(--dc1-border)', borderRadius: 4, padding: '2px 8px', cursor: 'pointer' }}>
              Clear filter
            </button>
          )}
        </div>
        <div className="dc1-table-wrapper">
          <table className="dc1-table" style={{ width: '100%' }}>
            <thead>
              <tr>
                <th>ID</th>
                <th>Source</th>
                <th>Severity</th>
                <th>Score</th>
                <th>Affected</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              {paged.map((v, i) => {
                const rating = v.ratings?.[0];
                const sev = (rating?.severity ?? 'unknown').toLowerCase();
                const sc = sevColor(sev);
                return (
                  <tr key={v.id + '-' + i}>
                    <td className="dc1-cell-name" style={{ fontFamily: 'monospace', fontSize: 12 }}>
                      {v.id.startsWith('CVE') ? (
                        <a href={`https://nvd.nist.gov/vuln/detail/${v.id}`} target="_blank" rel="noreferrer" style={{ color: '#2563eb', textDecoration: 'none' }}>
                          {v.id}
                        </a>
                      ) : v.id}
                    </td>
                    <td style={{ fontSize: 11, color: 'var(--dc1-text-muted)' }}>{v.source?.name ?? '—'}</td>
                    <td>
                      <span style={{ background: sc.bg, color: sc.text, padding: '2px 8px', borderRadius: 4, fontSize: 11, fontWeight: 600, textTransform: 'capitalize' }}>
                        {rating?.severity ?? 'Unknown'}
                      </span>
                    </td>
                    <td style={{ fontSize: 12 }}>{rating?.score ?? '—'}</td>
                    <td style={{ fontSize: 11 }}>
                      {v.affects?.map(a => a.ref).join(', ') || '—'}
                    </td>
                    <td style={{ maxWidth: 300, fontSize: 12, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                      {v.description ?? '—'}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        <Pagination
          page={page}
          total={filtered.length}
          pageSize={pageSize}
          onPageChange={setPage}
          onPageSizeChange={setPageSize}
        />
      </div>
    </>
  );
}
